<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Utility AR Tracker Ultimate</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- FontAwesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#1a1a1a">
  <style>
    /* --- UTILITY DARK THEME --- */
    body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: white; overflow: hidden; }
    
    #ar-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; display: none; }
    #map { height: 35vh; width: 100%; z-index: 1; border-bottom: 2px solid #333; }

    #dashboard {
        height: 65vh; background: #1a1a1a; 
        display: flex; flex-direction: column; align-items: center; 
        padding-top: 10px; position: relative; overflow-y: auto; padding-bottom: 40px;
    }

    /* COMPASS */
    #arrow-container { width: 60px; height: 60px; border: 3px solid #444; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: #222; margin-bottom: 5px; }
    #nav-arrow { font-size: 30px; color: #00ccff; transition: transform 0.5s ease; }

    /* STATS */
    .stats-row { display: flex; gap: 15px; text-align: center; margin-bottom: 10px; background: #222; padding: 5px 15px; border-radius: 10px; border: 1px solid #333; }
    .sub-stat { font-size: 10px; color: #aaa; text-transform: uppercase; }
    .sub-stat span { color: #00ccff; font-weight: bold; font-size: 14px; display: block; }

    /* CONTROLS GRID */
    .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; width: 95%; margin-bottom: 8px; }

    button {
        padding: 12px 5px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer;
        font-size: 10px; text-transform: uppercase; color: white;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.1s;
    }
    button:active { transform: scale(0.95); }
    button i { font-size: 18px; margin-bottom: 5px; }

    /* COLORS */
    .btn-help { background: #c0392b; } /* Red */
    .btn-strobe { background: #f1c40f; color: #000; } /* Yellow */
    .btn-walk { background: #e67e22; } /* Orange */
    .btn-med { background: #16a085; } /* Teal */
    .btn-fake { background: #34495e; } /* Navy */
    .btn-park { background: #d35400; } 
    .btn-guard { background: #27ae60; }
    .btn-safe { background: #8e44ad; }
    .btn-ar { background: #2980b9; }
    .btn-ice { background: white; color: red; border: 2px solid red; font-weight: 900; }

    /* ACTIVE STATES */
    .active-guard { background: #e74c3c !important; animation: pulse 1s infinite; }
    .active-safe { background: #c0392b !important; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    /* STROBE */
    body.strobe-mode { animation: strobe-flash 0.1s infinite; }
    @keyframes strobe-flash { 0% { background: #fff; filter: invert(0%); } 50% { background: #f00; filter: invert(100%); } 100% { background: #fff; filter: invert(0%); } }

    /* MODALS */
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
    .modal-content { background-color: #222; margin: 10% auto; padding: 20px; border: 1px solid #444; width: 85%; max-width: 400px; border-radius: 10px; color: white; text-align: center; position: relative; }
    .close-btn { position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer; color: #aaa; }
    
    .medical-item { text-align: left; background: #333; padding: 10px; margin-bottom: 5px; border-left: 4px solid #e74c3c; }
    .medical-item h3 { margin: 0; font-size: 14px; color: white; }
    .medical-item p { margin: 0; font-size: 12px; color: #ccc; }

    #alert-msg { position: absolute; top: 10px; width: 90%; text-align: center; background: rgba(255, 0, 0, 0.95); color: white; padding: 15px; border-radius: 5px; display: none; z-index: 3000; font-weight: bold; box-shadow: 0 0 20px red; }
  </style>
</head>
<body>

  <video id="ar-video" autoplay playsinline></video>
  <div id="alert-msg">‚ö†Ô∏è ALERT ACTIVE</div>
  <div id="map"></div>

  <div id="dashboard">
      <div id="arrow-container"><div id="nav-arrow">‚¨Ü</div></div>
      <h3 id="status-display" style="margin: 5px 0 10px 0; font-size:14px; color:#aaa;">Ready</h3>

      <div class="stats-row">
          <div class="sub-stat">STEPS<br><span id="step-count">0</span></div>
          <div class="sub-stat">KCAL<br><span id="cal-count">0</span></div>
          <div class="sub-stat">DIST<br><span id="total-dist">0.00</span> km</div>
      </div>
      
      <!-- ROW 1: EMERGENCY -->
      <div class="controls">
          <button class="btn-help" onclick="findNearby('hospital')"><i class="fa-solid fa-hospital"></i> Hospital</button>
          <button class="btn-help" onclick="findNearby('police')"><i class="fa-solid fa-building-shield"></i> Police</button>
          <button class="btn-strobe" onclick="toggleStrobe()"><i class="fa-solid fa-lightbulb"></i> Signal</button>
      </div>

      <!-- ROW 2: PERSONAL SAFETY -->
      <div class="controls">
          <button class="btn-walk" onclick="startLiveSession()"><i class="fa-solid fa-share-nodes"></i> Walk w/ Me</button>
          <button class="btn-med" onclick="openModal('medicalModal')"><i class="fa-solid fa-briefcase-medical"></i> First Aid</button>
          <button class="btn-fake" onclick="triggerFakeCall()"><i class="fa-solid fa-phone"></i> Fake Call</button>
      </div>

      <!-- ROW 3: UTILITIES -->
      <div class="controls">
          <button class="btn-park" onclick="handleParking()"><i class="fa-solid fa-square-parking"></i> <span id="park-text">Save Spot</span></button>
          <button class="btn-guard" id="btn-guard" onclick="toggleGeofence()"><i class="fa-solid fa-shield-halved"></i> Guard Area</button>
          <button class="btn-safe" id="btn-safe" onclick="toggleSafetyCheck()"><i class="fa-solid fa-hourglass-start"></i> Safe Timer</button>
      </div>

      <!-- ROW 4: AR & EXTRAS -->
      <div class="controls">
          <button class="btn-ar" onclick="toggleAR()"><i class="fa-solid fa-camera"></i> AR View</button>
          <button class="btn-ice" onclick="openModal('iceModal')"><i class="fa-solid fa-id-card"></i> I.C.E. CARD</button>
          <button style="background:#555" onclick="clearMemory()"><i class="fa-solid fa-rotate-right"></i> Reset</button>
      </div>
      <div class="controls">
          <button style="background: #d35400;" onclick="reportDanger()">
              <i class="fa-solid fa-triangle-exclamation" style="font-size: 20px;"></i> 
              REPORT HAZARD
          </button>
          <!-- Spacers to keep grid layout nice (Optional) -->
          <button style="visibility: hidden;"></button> 
          <button style="visibility: hidden;"></button>
      </div>
  </div>

  <!-- MODALS -->

  <!-- 1. WALK WITH ME MODAL -->
  <div id="shareModal" class="modal">
      <div class="modal-content">
          <span class="close-btn" onclick="closeModal('shareModal')">&times;</span>
          <h2>üì° Live Tracking</h2>
          <p>Share this link to let someone watch your location:</p>
          <input type="text" id="shareLinkInput" style="width:90%; padding:10px; margin:10px 0; color:black; border:none;" readonly>
          <button onclick="copyLink()" style="background:#27ae60; width:100%; padding:10px;">COPY LINK</button>
      </div>
  </div>

  <!-- 2. FIRST AID MODAL -->
  <div id="medicalModal" class="modal">
      <div class="modal-content">
          <span class="close-btn" onclick="closeModal('medicalModal')">&times;</span>
          <h2>üöë Quick Guide</h2>
          <div style="text-align:left; max-height:300px; overflow-y:auto;">
              <div class="medical-item"><h3>CPR</h3><p>Push hard/fast center chest (100bpm).</p></div>
              <div class="medical-item"><h3>Bleeding</h3><p>Direct pressure. Do not remove object.</p></div>
              <div class="medical-item"><h3>Choking</h3><p>5 Back blows. 5 Abdominal thrusts.</p></div>
              <div class="medical-item"><h3>Burn</h3><p>Cool water 10 mins. No ice/butter.</p></div>
          </div>
      </div>
  </div>

  <!-- 3. ICE CARD MODAL -->
  <div id="iceModal" class="modal" style="background: #c0392b;">
      <div class="modal-content" style="background:white; color:black; border:4px solid red;">
          <span class="close-btn" onclick="closeModal('iceModal')" style="color:black">&times;</span>
          <h1 style="color:red; margin:0;">üÜò MEDICAL ID</h1>
          <hr>
          <div style="text-align:left; font-size:16px;">
              <p><strong>NAME:</strong> <input type="text" placeholder="Type Name..." style="border:none; border-bottom:1px solid #000; width:70%"></p>
              <p><strong>BLOOD:</strong> <select><option>Unknown</option><option>O+</option><option>A+</option><option>B+</option></select></p>
              <p><strong>ALLERGIES:</strong> <input type="text" placeholder="e.g. Penicillin" style="color:red; font-weight:bold; width:100%"></p>
              <br>
              <a href="tel:112" style="display:block; text-align:center; background:red; color:white; padding:10px; text-decoration:none; font-weight:bold; border-radius:5px;">üìû CALL EMERGENCY</a>
          </div>
      </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  
  <script>
    // --- INIT ---
    const socket = io();
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // VARS
    let myLoc = null, targetLoc = null, heading = 0;
    let liveSessionId = null;
    let guardActive = false, guardCenter = null, guardCircle = null;
    let safetyTimer = null, safetyTimeLeft = 0;
    let parkingSpot = JSON.parse(localStorage.getItem('saved_parking')) || null;
    let totalDist = 0, lastPos = null;

    // MARKERS
    const redIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });
    const myMarker = L.marker([0,0]).bindTooltip("ME", {permanent:true, offset:[0,10]}).addTo(map);
    let targetMarker = null, navLine = null;

    // --- GEOLOCATION LOOP ---
    if(navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
            const { latitude: lat, longitude: lng, speed } = pos.coords;
            
            // Pedometer
            if(lastPos) {
                const d = getDist(lastPos.lat, lastPos.lng, lat, lng);
                if(d > 1 && d < 100) {
                    totalDist += d;
                    document.getElementById('total-dist').innerText = (totalDist/1000).toFixed(2);
                    document.getElementById('step-count').innerText = Math.floor(totalDist/0.76);
                    document.getElementById('cal-count').innerText = Math.floor((totalDist/0.76)*0.04);
                }
            }
            lastPos = { lat, lng };
            myLoc = { lat, lng };

            // Update Map
            myMarker.setLatLng([lat, lng]);
            if(!targetLoc) map.setView([lat, lng], 16);

            // Logic Checks
            updateNavigation();
            checkGeofence();
            
            // Broadcast (Public)
            socket.emit('send-location', { lat, lng, speed });
            
            // Broadcast (Private Room)
            if(liveSessionId) {
                socket.emit('send-private-location', { roomId: liveSessionId, lat, lng, speed });
            }

        }, err => console.error(err), { enableHighAccuracy: true });
    }

    // --- SOCKET LISTENERS ---
    socket.on('receive-sos', (id) => triggerAlarm(`SOS ALERT FROM USER ${id.substr(0,4)}`));
    
    // --- ADDED THIS MISSING LISTENER FOR SAFE TIMER ---
    socket.on('timer-alert', (data) => triggerAlarm(`üö® ${data.msg}`));
    
    socket.on('receive-location', (data) => {
        // Simplified: console.log("User nearby:", data.id);
    });

    // --- FEATURE FUNCTIONS ---

    // 1. WALK WITH ME
    function startLiveSession() {
        liveSessionId = Math.random().toString(36).substr(2, 9);
        socket.emit('join-session', liveSessionId);
        const link = `${window.location.origin}/track?session=${liveSessionId}`;
        document.getElementById('shareLinkInput').value = link;
        openModal('shareModal');
    }

    // 2. FAKE CALL (AudioContext - Unblockable)
    function triggerFakeCall() {
        const btn = document.querySelector('.btn-fake');
        const original = btn.innerHTML;
        
        const AC = window.AudioContext || window.webkitAudioContext;
        if(!AC) return alert("Browser incompatible");
        const ctx = new AC();
        if(ctx.state === 'suspended') ctx.resume();

        btn.style.background = "#e74c3c";
        btn.innerHTML = "<span>‚è≥</span> WAIT 5s...";

        setTimeout(() => {
            btn.innerHTML = original;
            btn.style.background = "#34495e";
            
            // Generate Ring
            const t = ctx.currentTime;
            const osc1 = ctx.createOscillator(); osc1.frequency.value = 440;
            const osc2 = ctx.createOscillator(); osc2.frequency.value = 480;
            const gain = ctx.createGain();
            
            osc1.connect(gain); osc2.connect(gain); gain.connect(ctx.destination);
            
            osc1.start(t); osc2.start(t);
            osc1.stop(t+6); osc2.stop(t+6);
            
            // Pulse Volume
            gain.gain.setValueAtTime(0.5, t);
            gain.gain.setValueAtTime(0, t+2);
            gain.gain.setValueAtTime(0.5, t+4);
            gain.gain.setValueAtTime(0, t+6);

            if(navigator.vibrate) navigator.vibrate([1000, 500, 1000]);

        }, 5000);
    }

    // 3. SAFE TIMER
    async function toggleSafetyCheck() {
        const btn = document.getElementById('btn-safe');
        if(safetyTimer) {
            // Stop
            clearInterval(safetyTimer); safetyTimer = null;
            btn.classList.remove('active-safe'); btn.innerHTML = '<i class="fa-solid fa-hourglass-start"></i> Safe Timer';
            await fetch('/api/stop-timer', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({socketId: socket.id}) });
            stopAlarm();
        } else {
            // Start
            const mins = prompt("Set timer for how many minutes?", "10");
            if(!mins) return;
            
            safetyTimeLeft = parseInt(mins) * 60;
            btn.classList.add('active-safe');
            
            await fetch('/api/start-timer', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({socketId: socket.id, minutes: mins}) });
            
            safetyTimer = setInterval(() => {
                safetyTimeLeft--;
                btn.innerHTML = `<span>‚è≥</span> ${Math.floor(safetyTimeLeft/60)}m ${safetyTimeLeft%60}s`;
                if(safetyTimeLeft <= 0) clearInterval(safetyTimer); 
            }, 1000);
        }
    }

    // 4. SHAKE TO SOS
    let lastX=0, lastY=0, lastZ=0, lastShake=0;
    if(window.DeviceMotionEvent) {
        window.addEventListener('devicemotion', e => {
            const acc = e.accelerationIncludingGravity;
            if(!acc) return;
            const delta = Math.abs(acc.x-lastX) + Math.abs(acc.y-lastY) + Math.abs(acc.z-lastZ);
            if(delta > 25) { // Sensitivity
                const now = Date.now();
                if(now - lastShake > 2000) {
                    lastShake = now;
                    if(confirm("SHAKE DETECTED! SEND SOS?")) {
                        socket.emit('signal-sos');
                        triggerAlarm("SOS TRIGGERED BY SHAKE");
                    }
                }
            }
            lastX=acc.x; lastY=acc.y; lastZ=acc.z;
        });
    }

    // 5. BATTERY GUARDIAN
    if(navigator.getBattery) {
        navigator.getBattery().then(b => {
            b.addEventListener('levelchange', () => {
                if(b.level < 0.15 && !b.charging) {
                     socket.emit('send-location', { lat: myLoc.lat, lng: myLoc.lng, status: 'CRITICAL BATTERY' });
                     alert("Battery Low! Last location sent to server.");
                }
            });
        });
    }

    // --- UTILITIES ---
    function handleParking() {
        if(parkingSpot) {
            targetLoc = parkingSpot;
            setTarget(targetLoc);
            if(confirm("Navigating to car. Clear spot?")) {
                localStorage.removeItem('saved_parking'); parkingSpot=null;
                document.getElementById('park-text').innerText = "Save Spot";
            }
        } else {
            if(!myLoc) return alert("No GPS");
            parkingSpot = myLoc;
            localStorage.setItem('saved_parking', JSON.stringify(parkingSpot));
            document.getElementById('park-text').innerText = "Find Car";
            alert("Spot Saved");
        }
    }
    if(parkingSpot) document.getElementById('park-text').innerText = "Find Car";

    function toggleGeofence() {
        if(!myLoc) return alert("No GPS");
        const btn = document.getElementById('btn-guard');
        guardActive = !guardActive;
        if(guardActive) {
            guardCenter = myLoc;
            btn.classList.add('active-guard');
            guardCircle = L.circle([myLoc.lat, myLoc.lng], {radius:50, color:'red'}).addTo(map);
            alert("Guard Active. Don't move > 50m.");
        } else {
            btn.classList.remove('active-guard');
            if(guardCircle) map.removeLayer(guardCircle);
            stopAlarm();
        }
    }

    function checkGeofence() {
        if(!guardActive || !guardCenter || !myLoc) return;
        if(getDist(guardCenter.lat, guardCenter.lng, myLoc.lat, myLoc.lng) > 50) triggerAlarm("PERIMETER BREACHED");
    }

    function setTarget(loc) {
        if(targetMarker) map.removeLayer(targetMarker);
        targetMarker = L.marker([loc.lat, loc.lng], {icon: redIcon}).addTo(map);
        if(navLine) map.removeLayer(navLine);
        navLine = L.polyline([[myLoc.lat, myLoc.lng], [loc.lat, loc.lng]], {color:'#00ccff'}).addTo(map);
    }

    function updateNavigation() {
        if(!myLoc || !targetLoc) return;
        const dist = getDist(myLoc.lat, myLoc.lng, targetLoc.lat, targetLoc.lng);
        document.getElementById('status-display').innerText = `Dist: ${Math.round(dist)}m`;
        const bearing = getBearing(myLoc.lat, myLoc.lng, targetLoc.lat, targetLoc.lng);
        document.getElementById('nav-arrow').style.transform = `rotate(${bearing - heading}deg)`;
    }

    function findNearby(type) {
        if(!myLoc) return alert("No GPS");
        const q = type==='hospital'?'hospitals':'police';
        window.open(`https://www.google.com/maps/search/${q}/@${myLoc.lat},${myLoc.lng},14z`);
    }

    function toggleAR() {
        document.body.classList.toggle('ar-active');
        const v = document.getElementById('ar-video');
        if(v.style.display==='block') { v.style.display='none'; }
        else { navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(s=> { v.srcObject=s; v.style.display='block'; }); }
    }

    function triggerAlarm(msg) {
        const box = document.getElementById('alert-msg');
        box.innerText = msg; box.style.display='block';
        const u = new SpeechSynthesisUtterance(msg);
        window.speechSynthesis.speak(u);
        if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
    }
    function stopAlarm() { document.getElementById('alert-msg').style.display='none'; window.speechSynthesis.cancel(); }
    
    // Helpers
    function openModal(id) { document.getElementById(id).style.display='block'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function copyLink() { document.getElementById('shareLinkInput').select(); document.execCommand('copy'); alert("Link Copied"); }
    function clearMemory() { localStorage.clear(); location.reload(); }
    function toggleStrobe() { document.body.classList.toggle('strobe-mode'); }
    function getDist(lat1,lon1,lat2,lon2) { const R=6371e3; const dL=(lat2-lat1)*Math.PI/180; const dO=(lon2-lon1)*Math.PI/180; const a=Math.sin(dL/2)*Math.sin(dL/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dO/2)*Math.sin(dO/2); return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
    function getBearing(lat1,lon1,lat2,lon2) { const y=Math.sin((lon2-lon1)*Math.PI/180)*Math.cos(lat2*Math.PI/180); const x=Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180)-Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos((lon2-lon1)*Math.PI/180); return (Math.atan2(y,x)*180/Math.PI+360)%360; }
    
    // Compass
    if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS requires permission, handled on first button click usually. 
        // For simplicity, we assume generic support or user triggers compass btn in older code
        // Adding simple listener:
        window.addEventListener('deviceorientation', e => heading = e.webkitCompassHeading || (360-e.alpha));
    } else {
        window.addEventListener('deviceorientation', e => heading = (360-e.alpha));
    }
      // --- SERVER-SIDE FEATURES INTEGRATION ---

    // 1. Report Danger Function
    async function reportDanger() {
        if(!myLoc) return alert("Waiting for GPS...");
        
        const type = prompt("What is the hazard? (e.g. Fire, Thief, Dog, Accident)");
        if(!type) return;

        // Send to Node.js Server
        const res = await fetch('/api/report-danger', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ lat: myLoc.lat, lng: myLoc.lng, type: type })
        });
        const data = await res.json();
        
        // Visual Feedback
        L.circle([myLoc.lat, myLoc.lng], {color: 'orange', radius: 30}).addTo(map);
        alert("Hazard Reported! Server will warn others nearby.");
    }

    // 2. Listen for New Hazards (from other users)
    socket.on('new-hazard', (data) => {
        L.marker([data.lat, data.lng]).addTo(map)
          .bindPopup(`‚ö†Ô∏è DANGER: ${data.type}`).openPopup();
        L.circle([data.lat, data.lng], {color: 'orange', radius: 100}).addTo(map);
    });

    // 3. Listen for Existing Hazards (on login)
    socket.on('sync-dangers', (zones) => {
        zones.forEach(z => {
            L.circle([z.lat, z.lng], {color: 'orange', radius: 100}).addTo(map);
        });
    });

    // 4. LISTEN FOR SERVER WARNING (Geofencing)
    // The server calculated we are close, so we alarm the user
    socket.on('danger-proximity', (data) => {
        triggerAlarm(`WARNING! ${data.type} detected ${data.dist} meters away!`);
        // Visual flash
        document.body.style.backgroundColor = "red";
        setTimeout(() => document.body.style.backgroundColor = "#121212", 500);
    });
  </script>
</body>
</html>
